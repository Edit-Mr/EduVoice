<!-- @format -->

<!DOCTYPE html>
<html lang="zh-Hant">
    <head>
        <%- include("partials/meta") %>
        <title><%= ruleData.name %> | 學聲 EduVoice</title>
        <style>
            main {
                padding-top: 5rem;
                transition: all 0.5s;
            }
            .intro-container {
                display: flex;
                gap: 2rem;
            }
            .intro {
                flex-grow: 1;
            }
            .box {
                background-color: #fff;
                border-radius: 1rem;
                padding: 24px;
                flex-grow: 1;
            }
            .pie-chart {
                flex: 0 0;
                display: flex;
                flex-direction: column;
                white-space: nowrap;
            }
            .pie-box {
                display: flex;
                justify-content: center;
                align-items: center;
                flex-grow: 1;
                min-width: 14rem;
                gap: 2rem;
            }
            .pie {
                width: 10rem;
                height: 10rem;
                border-radius: 50%;
                /* background: conic-gradient(
                    #f00 0% 20%,
                    rgb(163, 163, 163) 20% 30%,
                    #ff0 30% 60%,
                    #0f0 60% 100%
                ); */
            }
            .pie-square {
                display: inline-block;
                width: 1rem;
                height: 1rem;
                margin-right: 0.5rem;
            }

            .green {
                background-color: #0f0;
            }

            .yellow {
                background-color: #ff0;
            }

            .red {
                background-color: #f00;
            }

            .school-status {
                display: flex;
                flex-wrap: wrap;
                gap: 2rem;
            }
            .school-status > div {
                flex: 1;
            }
            .school-status h2 {
                text-align: center;
            }
            .school-status span {
                text-align: right;
            }
            .school-status a {
                display: flex;
                justify-content: space-between;
                padding: 1rem;
                border-radius: 0.375rem;
                background-color: #f0f0f0;
                margin-bottom: 0.5rem;
                text-decoration: none;
                color: #000;
            }
        </style>
    </head>

    <body class="aemfont-GenWanMin">
        <%- include ("partials/nav") %>
        <main>
            <section>
                <h1><%= schoolData.name %></h1>
                <p><%= schoolData.location %></p>
            </section>
            <section class="intro-container">
                <div class="intro box">
                    <h2>校園簡介</h2>
                    <p>
                        <%= schoolData.intro %>
                    </p>
                </div>
                <div class="pie-chart box">
                    <h2>遵守法規</h2>
                    <div class="pie-box comply_rules">
                        <!-- 這一塊派不確定要統計什麼 -->
                        <div class="pie" id="comply_rule_pie"></div>
                        <div>
                            <div class="green pie-square"></div>
                            <span class="implemented">已實施 ：</span>
                            <br/>
                            <div class="yellow pie-square"></div>
                            <span class="Testing">實驗中 ：</span>
                            <br/>
                            <div class="red pie-square"></div>
                            <span class="notYet">未實施 ：</span>
                        </div>
                    </div>
                </div>
                <div class="pie-chart box">
                    <h2>所有政策</h2>
                    <div class="pie-box list_all">
                        <!-- list_all 是母標籤，用分別兩張圓餅的狀態 -->
                        <div class="pie" id="allPolicies_pie"></div>
                        <div>
                            <div class="green pie-square" ></div>
                            <span class="implemented">已實施 ：</span>
                            <br/>
                            <div class="yellow pie-square"></div>
                            <span class="Testing">實驗中 ：</span>
                            <br />
                            <div class="red pie-square"></div>
                            <span class="notYet">未實施 ：</span>
                        </div>
                    </div>
                </div>
            </section>
            <% 
            let countDone = 0, countNotYet = 0, countTesting = 0;
            let mandatoryDone = 0, mandatoryNotYet = 0, mandatoryTesting = 0;
            %>
            <section class="school-status">
                <div>
                    <h2>已實施</h2>
                    <% if (ruleData && ruleData.length > 0) { %>
                        
                        <% ruleData.forEach(rule => { %>
                                <%if (rule.status == "O") { %>
                                    <%countDone++;%>
                                    <a href="/i/<%= rule.id %>"><%= rule.title %> <span>✅</span></a>
                                    <% if (rule.is_mandatory) { %>
                                        <%mandatoryDone++;}%>
                            <% }}); %>
                    <% } else { %>
                        <p>目前沒有資料</p>
                    <% } %>
                </div>
                <div>
                    <h2>實驗階段 / 半開放</h2>
                    <% if (ruleData && ruleData.length > 0) { %>
                        
                        <% ruleData.forEach(rule => { %>
                                <%if (rule.status == "?") { %>
                                    <%countTesting++;%>
                                    <!-- <a onclick="alert('更新紀錄\n❌2023.1.1 糾察隊門口登記 (學生)\n🟡 2024.1.1 登記不懲處 (老師)')">穿便服上學 <span>🟡</span></a> -->
                                    <a href="/i/<%= rule.id %>"><%= rule.title %> <span>🟡</span></a>
                                    <% if (rule.is_mandatory) { %>
                                        <%mandatoryTesting++;}%>
                            <% }}); %>
                    <% } else { %>
                        <p>目前沒有資料</p>
                    <% } %>
                </div>
                <div>
                    <h2>未實施</h2>
                    <% if (ruleData && ruleData.length > 0) { %>
                        
                        <% ruleData.forEach(rule => { %>
                                <%if (rule.status == "X") { %>
                                    <%countNotYet++;%>
                                    <a href="/i/<%= rule.id %>"><%= rule.title %> <span>❌</span></a>
                                    <% if (rule.is_mandatory) { %>
                                        <%mandatoryNotYet++;}%>
                            <% }}); %>
                    <% } else { %>
                        <p>目前沒有資料</p>
                    <% } %>
                </div>
                <% const totalCount = countDone + countNotYet + countTesting;
                const mandatoryTotal = mandatoryDone + mandatoryNotYet + mandatoryTesting;
                %>
            </section>
        </main>
        <%
            const all_policy_Red= ((countNotYet / totalCount) * 100).toFixed(0);
            const all_policy_yellow= ((countTesting / totalCount) * 100).toFixed(0);
            const all_policy_green = ((countDone / totalCount) * 100).toFixed(0);
            const all_policy_pieFalg = totalCount == 0 ? false : true;//表示是否有資料

            const mandatory_Red= ((mandatoryNotYet / mandatoryTotal) * 100).toFixed(0);
            const mandatory_yellow= ((mandatoryTesting / mandatoryTotal) * 100).toFixed(0);
            const mandatory_green = ((mandatoryDone / mandatoryTotal) * 100).toFixed(0);
            const mandatory_pieFalg = mandatoryTotal == 0 ? false : true;//表示是否有資料
        %>
        <script>
            function shownodata(pie_class="")
            {
                //comply_rules or list_all
                console.log(`${pie_class}.pie`)
                document.querySelector(`${pie_class}.notYet`).innerText ="沒有資料"
                document.querySelector(`${pie_class}.Testing`).innerText="沒有資料"
                document.querySelector(`${pie_class}.implemented`).innerText ="沒有資料"
                document.querySelector(`${pie_class}.pie`).style.background = `conic-gradient(
                        #cfcfcc 0% 100%
                    )`;
            }
            let pieRed =0;
            //不用管 VSC 的紅色波浪線，這是 EJS 的語法，不是 JS 的語法
            if(<%= all_policy_pieFalg %>){
                document.getElementById('allPolicies_pie').style.background = `conic-gradient(
                        #f00 0% <%- all_policy_Red %>%,
                        #ff0 <%- all_policy_Red %>% <%- all_policy_Red+all_policy_yellow %>%,
                        #0f0 <%- all_policy_Red+all_policy_yellow %>% 100%
                    )`;
                document.querySelector('.list_all .implemented').innerText += ` <%- all_policy_green %>%`;
                document.querySelector('.list_all .notYet').innerText += ` <%- all_policy_Red %>%`;
                document.querySelector('.list_all .Testing').innerText += ` <%- all_policy_yellow %>%`;
                if(<%= mandatory_pieFalg %>){
                    
                    document.getElementById('comply_rule_pie').style.background = `conic-gradient(
                        #f00 0% <%- mandatory_Red %>%,
                        #ff0 <%- mandatory_Red %>% <%- mandatory_Red+mandatory_yellow %>%,
                        #0f0 <%- mandatory_Red+mandatory_yellow %>% 100%
                    )`;
                    document.querySelector('.comply .implemented').innerText += ` <%- mandatory_green %>%`;
                    document.querySelector('.comply .notYet').innerText += ` <%- mandatory_Red %>%`;
                    document.querySelector('.comply .Testing').innerText += ` <%- mandatory_yellow %>%`;
                }
                else
                {
                    // 選擇器空格一定要留著，因為要選擇某個 class 底下的元素做修改
                    shownodata('.comply_rules ');
                }
            }
            else
            {
                console.log("no data")
                shownodata('.pie-box ');
            }
          </script> 
        <%- include("partials/footer") %>
    </body>
</html>
